name: "Manual Remote Merge: Dev -> Pre"

on:
  workflow_dispatch:
    inputs:
      target-repo:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó (–Ω–∞–ø—Ä. chTestORG/ui-app)'
        required: true
        default: 'chTestORG/org-front-end'

jobs:
  merge-check-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target-repo }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          path: target-repo

      - name: Check for Changes & Merge
        id: check_changes
        working-directory: ./target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω—ñ –≥—ñ–ª–∫–∏
          git fetch origin develop prerelease

          # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∫–æ–º–º—ñ—Ç–∏ –≤ develop, —è–∫–∏—Ö –Ω–µ–º–∞—î –≤ prerelease
          # rev-list --count –≤–∏–¥–∞—Å—Ç—å —á–∏—Å–ª–æ –±—ñ–ª—å—à–µ 0, —è–∫—â–æ –∑–º—ñ–Ω–∏ —î
          CHANGES_COUNT=$(git rev-list --count prerelease..origin/develop)
          
          echo "Found $CHANGES_COUNT new commits in develop."
          
          if [ "$CHANGES_COUNT" -eq "0" ]; then
            echo "No changes to merge. Skipping PR creation."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT

          # –°—Ç–≤–æ—Ä—é—î–º–æ –≥—ñ–ª–∫—É —Ç–∞ –º–µ—Ä–¥–∂–∏–º–æ
          git checkout prerelease
          git branch -D merge-develop-into-prerelease || true
          git checkout -b merge-develop-into-prerelease
          
          if git merge origin/develop; then
            git push origin merge-develop-into-prerelease --force
          else
            echo "‚ùå Merge conflict detected! Stopping."
            exit 1
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const [owner, repo] = "${{ inputs.target-repo }}".split('/');
            try {
              const { data: pullRequest } = await github.rest.pulls.create({
                owner: owner,
                repo: repo,
                title: 'üöÄ Merge: develop -> prerelease',
                head: 'merge-develop-into-prerelease',
                base: 'prerelease',
                body: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π PR –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑–º—ñ–Ω –º—ñ–∂ –≥—ñ–ª–∫–∞–º–∏.',
              });
              core.info(`PR created: ${pullRequest.html_url}`);
            } catch (error) {
              if (error.message.includes('A pull request already exists')) {
                core.info('PR –≤–∂–µ —ñ—Å–Ω—É—î, –≥—ñ–ª–∫—É –æ–Ω–æ–≤–ª–µ–Ω–æ.');
              } else {
                core.setFailed(`API Error: ${error.message}`);
              }
            }