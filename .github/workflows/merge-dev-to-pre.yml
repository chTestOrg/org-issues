name: "Manual Remote Merge: Dev -> Pre"

on:
  workflow_dispatch:
    inputs:
      target-repo:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó (–Ω–∞–ø—Ä. chTestORG/ui-app)'
        required: true
        default: 'chTestORG/org-front-end'

jobs:
  merge-check-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target-repo }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          path: target-repo

      - name: Configure Git & Fetch
        working-directory: ./target-repo
        run: |
          echo "üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "üì° –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ –≥—ñ–ª–∫–∏ develop —Ç–∞ prerelease..."
          git fetch origin develop prerelease

      - name: Check for Changes
        id: check
        working-directory: ./target-repo
        run: |
          echo "üîç –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –≥—ñ–ª–æ–∫ origin/prerelease —Ç–∞ origin/develop..."
          COUNT=$(git rev-list --count origin/prerelease..origin/develop)
          
          if [ "$COUNT" -eq "0" ]; then
            echo "‚úÖ –ó–º—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ì—ñ–ª–∫–∞ prerelease –≤–∂–µ –º—ñ—Å—Ç–∏—Ç—å —É—Å—ñ –∫–æ–º–º—ñ—Ç–∏ –∑ develop."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "üöÄ –ó–Ω–∞–π–¥–µ–Ω–æ $COUNT –Ω–æ–≤–∏—Ö –∫–æ–º–º—ñ—Ç—ñ–≤ —É develop. –ì–æ—Ç—É—î–º–æ—Å—è –¥–æ –º–µ—Ä–¥–∂—É..."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Merge Branch
        if: steps.check.outputs.has_changes == 'true'
        working-directory: ./target-repo
        run: |
          echo "üßπ –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö –≥—ñ–ª–æ–∫..."
          git push origin --delete merge-develop-into-prerelease || echo "‚ÑπÔ∏è –ì—ñ–ª–∫–∞ –≤ origin –≤—ñ–¥—Å—É—Ç–Ω—è, –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ."
          git branch -D merge-develop-into-prerelease || echo "‚ÑπÔ∏è –õ–æ–∫–∞–ª—å–Ω–∞ –≥—ñ–ª–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—è."
          
          echo "üå± –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –≥—ñ–ª–∫–∏ 'merge-develop-into-prerelease' –Ω–∞ –±–∞–∑—ñ 'prerelease'..."
          git checkout -B prerelease origin/prerelease
          git checkout -b merge-develop-into-prerelease

      - name: Execute Merge & Push
        if: steps.check.outputs.has_changes == 'true'
        working-directory: ./target-repo
        run: |
          echo "üîÄ –ü–æ—á–∞—Ç–æ–∫ –º–µ—Ä–¥–∂—É develop -> merge-develop-into-prerelease..."
          if git merge origin/develop --no-edit; then
            echo "‚úÖ –ú–µ—Ä–¥–∂ —É—Å–ø—ñ—à–Ω–∏–π! –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≥—ñ–ª–∫—É –≤ origin..."
            git push origin merge-develop-into-prerelease
          else
            echo "‚ùå –ü–û–ú–ò–õ–ö–ê: –í–∏—è–≤–ª–µ–Ω–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –º–µ—Ä–¥–∂—É!"
            echo "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏—Ä—ñ—à—ñ—Ç—å –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –≤—Ä—É—á–Ω—É –≤ –≥—ñ–ª—Ü—ñ develop –∞–±–æ prerelease."
            exit 1
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const [owner, repo] = "${{ inputs.target-repo }}".split('/');
            const prTitle = 'üöÄ Merge: develop -> prerelease';
            
            console.log(`ü§ñ –°–ø—Ä–æ–±–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ PR —É ${owner}/${repo}...`);
            
            try {
              const { data: pullRequest } = await github.rest.pulls.create({
                owner,
                repo,
                title: prTitle,
                head: 'merge-develop-into-prerelease',
                base: 'prerelease',
                body: '### ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è\n–¶–µ–π PR —Å—Ç–≤–æ—Ä–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–ª—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è –∑–º—ñ–Ω –∑ `develop` —É `prerelease`.',
              });
              console.log(`‚úÖ PR —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ: ${pullRequest.html_url}`);
            } catch (error) {
              console.log(`‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: ${error.message}`);
            }