name: "Create Merge Develop into Prerelease PR"

on:
  workflow_dispatch: # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É (–∑—Ä—É—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—ñ–≤)
  # –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ trigger –Ω–∞ push —É develop, —è–∫—â–æ —Ç—Ä–µ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –¢—É—Ç –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–∞ –≤—Å—è —ñ—Å—Ç–æ—Ä—ñ—è –¥–ª—è –º–µ—Ä–¥–∂—É
          token: ${{ steps.app-token.outputs.token }}

      - name: Git Branching & Merge
        run: |
          # 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è prerelease —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –≥—ñ–ª–∫–∏
          git checkout prerelease
          git pull origin prerelease
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –≥—ñ–ª–∫—É –≤—ñ–¥ prerelease (–≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É, —è–∫—â–æ —î)
          git branch -D merge-develop-into-prerelease || true
          git checkout -b merge-develop-into-prerelease

          # 3. –°–ø—Ä–æ–±–∞ –º–µ—Ä–¥–∂—É develop
          echo "Merging develop into the new branch..."
          if git merge origin/develop; then
            echo "Merge successful, pushing branch..."
            git push origin merge-develop-into-prerelease --force
          else
            echo "Conflict detected! You will need to resolve it manually."
            exit 1
          fi

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            try {
              const { data: pullRequest } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üöÄ Merge: develop -> prerelease',
                head: 'merge-develop-into-prerelease',
                base: 'prerelease',
                body: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π PR –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –≥—ñ–ª–æ–∫ develop —Ç–∞ prerelease.',
                draft: false
              });
              core.info(`PR created: ${pullRequest.html_url}`);
            } catch (error) {
              if (error.message.includes('A pull request already exists')) {
                core.info('PR –≤–∂–µ —ñ—Å–Ω—É—î, –æ–Ω–æ–≤–ª—é—î–º–æ –≥—ñ–ª–∫—É...');
              } else {
                core.setFailed(`–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è PR: ${error.message}`);
              }
            }