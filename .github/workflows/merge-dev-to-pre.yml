name: "Manual Remote Merge: Dev -> Pre"

on:
  workflow_dispatch:
    inputs:
      target-repo:
        description: '–†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó (–Ω–∞–ø—Ä. chTestORG/ui-app)'
        required: true
        default: 'chTestORG/org-front-end'

jobs:
  merge-check-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target-repo }}
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          path: target-repo

      - name: Configure Git & Fetch
        working-directory: ./target-repo
        run: |
          echo "üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ git..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "üì° –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ –≥—ñ–ª–∫–∏..."
          git fetch origin develop prerelease

      - name: Sync Integrity Check (Prerelease in Develop)
        working-directory: ./target-repo
        run: |
          echo "üõ°Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ: —á–∏ –≤—Å—ñ –∫–æ–º–º—ñ—Ç–∏ –∑ prerelease —î –≤ develop?"
          # –†–∞—Ö—É—î–º–æ –∫–æ–º–º—ñ—Ç–∏, —è–∫—ñ —î –≤ prerelease, –∞–ª–µ –≤—ñ–¥—Å—É—Ç–Ω—ñ –≤ develop
          BEHIND_COUNT=$(git rev-list --count origin/develop..origin/prerelease)
          
          if [ "$BEHIND_COUNT" -gt "0" ]; then
            echo "‚ùå –ü–û–ú–ò–õ–ö–ê –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á!"
            echo "–ì—ñ–ª–∫–∞ develop –≤—ñ–¥—Å—Ç–∞—î –≤—ñ–¥ prerelease –Ω–∞ $BEHIND_COUNT –∫–æ–º–º—ñ—Ç—ñ–≤."
            echo "–ß–µ—Ä–µ–∑ –∫–∞—Å–∫–∞–¥–Ω–∏–π –º–µ—Ä–¥–∂ —Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–ª–∏—Ç–∏ prerelease –≤ develop,"
            echo "—â–æ–± –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ –¥–∞–Ω—ñ. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è –∑—É–ø–∏–Ω–µ–Ω–∞."
            exit 1
          else
            echo "‚úÖ –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞. develop –º—ñ—Å—Ç–∏—Ç—å —É—Å—ñ –∑–º—ñ–Ω–∏ –∑ prerelease."
          fi

      - name: Check for Changes (Develop in Prerelease)
        id: check
        working-directory: ./target-repo
        run: |
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –Ω–æ–≤–∏—Ö —Ñ—ñ—á —É develop..."
          COUNT=$(git rev-list --count origin/prerelease..origin/develop)
          
          if [ "$COUNT" -eq "0" ]; then
            echo "‚úÖ –ó–º—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. prerelease –≤–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "üöÄ –ó–Ω–∞–π–¥–µ–Ω–æ $COUNT –Ω–æ–≤–∏—Ö –∫–æ–º–º—ñ—Ç—ñ–≤ —É develop. –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ..."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Merge Branch
        if: steps.check.outputs.has_changes == 'true'
        working-directory: ./target-repo
        run: |
          echo "üßπ –û—á–∏—â–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö –≥—ñ–ª–æ–∫..."
          git push origin --delete merge-develop-into-prerelease || echo "‚ÑπÔ∏è –í—ñ–¥–¥–∞–ª–µ–Ω–∞ –≥—ñ–ª–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—è."
          git branch -D merge-develop-into-prerelease || echo "‚ÑπÔ∏è –õ–æ–∫–∞–ª—å–Ω–∞ –≥—ñ–ª–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—è."
          
          echo "üå± –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –≥—ñ–ª–∫–∏ 'merge-develop-into-prerelease' –Ω–∞ –±–∞–∑—ñ 'prerelease'..."
          git checkout -B prerelease origin/prerelease
          git checkout -b merge-develop-into-prerelease

      - name: Execute Merge & Push
        if: steps.check.outputs.has_changes == 'true'
        working-directory: ./target-repo
        run: |
          echo "üîÄ –ú–µ—Ä–¥–∂ develop -> merge-develop-into-prerelease..."
          if git merge origin/develop --no-edit; then
            echo "‚úÖ –£—Å–ø—ñ—Ö! –ü—É—à–∏–º–æ –≤ origin..."
            git push origin merge-develop-into-prerelease
          else
            echo "‚ùå –ö–û–ù–§–õ–Ü–ö–¢! –ü–æ—Ç—Ä—ñ–±–Ω–µ —Ä—É—á–Ω–µ –≤—Ç—Ä—É—á–∞–Ω–Ω—è."
            exit 1
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const [owner, repo] = "${{ inputs.target-repo }}".split('/');
            try {
              const { data: pr } = await github.rest.pulls.create({
                owner,
                repo,
                title: 'üöÄ Merge: develop -> prerelease',
                head: 'merge-develop-into-prerelease',
                base: 'prerelease',
                body: '### ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è\n\n**–£–≤–∞–≥–∞:** –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ (develop –º—ñ—Å—Ç–∏—Ç—å —É—Å—ñ –∑–º—ñ–Ω–∏ –∑ prerelease).',
              });
              console.log(`‚úÖ PR —Å—Ç–≤–æ—Ä–µ–Ω–æ: ${pr.html_url}`);
            } catch (e) {
              console.log(`‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞/PR –≤–∂–µ —î: ${e.message}`);
            }